import os
import json
import asyncio
import aiohttp
import logging
from datetime import datetime

# Configuration
TELEGRAM_BOT_TOKEN = os.environ.get('TELEGRAM_BOT_TOKEN', '')
TELEGRAM_CHAT_ID = os.environ.get('TELEGRAM_CHAT_ID', '')
STEAM_API_KEY = os.environ.get('STEAM_API_KEY', '')

# Steam account IDs to monitor (just the IDs, no names needed)
STEAM_ACCOUNTS = [
    
  '76561198984012090','76561198976365722','76561198983665315','76561198999295056','76561198990986431','76561199051139473',
'76561199019043629','76561199012385843','76561199056392996','76561198992115601','76561198982924658','76561198983988206',
'76561198982810287','76561199365722431','76561198915424578',
'76561198983153420','76561198998286107','76561199022488097','76561198983320859','76561198983069725','76561198983353903',
'76561198983694484','76561198983100050','76561198983242304','76561198976312243','76561198983520803','76561199018621489',
'76561198988159616','76561198983202786','76561198983474956','76561198983545937','76561199045966635','76561198876443144',
'76561199025677208','76561198983349056','76561198983320002','76561198983728791','76561198989441790','76561199054396658',
'76561198833535455','76561198833868090','76561198983413899','76561198833885060','76561198988622612','76561199054395234',
'76561199058188792','76561199031597559','76561198983302978','76561199057992624','76561198983148280','76561199046214359',
'76561199030552461','76561198995059805','76561198983106794','76561198983348689','76561198983316816','76561198983472617',
'76561198983083114','76561198991497157','76561198984309667','76561199052554996','76561199009993310','76561198983351810',
'76561198976526532','76561199008394918','76561199032726730',
'76561199446533386', '76561199446216542', '76561199384518021', '76561199446319387', '76561199446640460',
'76561199446632955', '76561199446930618', '76561199444359737', '76561199445919724', '76561199445082525',
'76561199444703394', '76561199444697918', '76561199446296965', '76561199444655816', '76561199446157642',
'76561198798547780', '76561199444570942', '76561199444502389', '76561199446272459', '76561199444619050',
'76561199444776217', '76561199447532542', '76561199444595607', '76561199444940465', '76561199446041127',
'76561199565717554', '76561198828973408', '76561199488637816', '76561199568165530', '76561199117145071',
'76561198037794924', '76561199446156427', '76561198981852128', '76561199444366211', '76561198109141690',
'76561199446189789', '76561199194971149',
'76561198023985820', '76561199444910361', '76561199444571917', '76561198981863680', '76561199446952303',
'76561199446301996', '76561198870902338', '76561198992001641', '76561199565151025', '76561199444716503',
'76561199561779483', '76561199165557359', '76561199476267965', '76561199227275651', '76561199446218457',
'76561198305910045', '76561199444939556', '76561199534437684', '76561199367835001',
'76561199182842365', '76561199567263297', '76561198976944326', '76561198377151963', '76561198865568681',
'76561198866186304', '76561198865675327', '76561198865570879', '76561198865992424', '76561198865604282',
'76561198982352809', '76561198981826428',
'76561198982098003', '76561198981687497', '76561198982025072', '76561198982004306', '76561198981965630',
'76561198981533425', '76561198420878452', '76561198982498486', '76561198981840922', '76561198981950835',
'76561198982000943', '76561198982024818', '76561198981605152', '76561198981696990', '76561198982022986',
'76561198982014126', '76561198981744933', '76561198952412007',
'76561198982494743', '76561198981834470', '76561198991933645', '76561198981899402', '76561198991797610',
'76561198991795584', '76561198981658239', '76561198981854624', '76561198981894870', '76561198982339727',
'76561198981599636', '76561198981744933', '76561198952412007', '76561198981850481', '76561198991917740',
'76561198981956548', '76561198991530058', '76561198981712766', '76561198981874249',
'76561198992060960', '76561198981854098', '76561198982167863', '76561198991786779', '76561198991472012',
'76561198981712824', '76561198981823814', '76561198982210629', '76561198982107134', '76561198981692154',
'76561198982125999', '76561198991482842', '76561198981710386', '76561198981615951', '76561199112576730',
'76561198952247802', '76561198952688868', '76561198982038155', '76561198982083097',
'76561198992190595', '76561198991994121', '76561198982155056', '76561198992392417', '76561198982185002',
'76561198992003845', '76561198991616353', '76561198981947678', '76561198991947764', '76561198991830052',
'76561198991985910', '76561198981807055', '76561198992292127', '76561198981924280', '76561198982083097',
'76561198982038155', '76561198982310395', '76561198991789323', '76561198991977801', '76561198982196716',
'76561198991616353', '76561198981776216', '76561198810455186', '76561199118565401', '76561198323551893',
'76561198061670313', '76561198387184166', '76561198997843749', '76561198425269460', '76561198318518833',
'76561198086442694', '76561198023432268', '76561198256476085', '76561198071171725', '76561198291165040',
'76561199246604041', '76561198342495834', '76561199444732654', '76561199565355271', '76561199247530566',
'76561199078775076', '76561199444515274', '76561198118631620', '76561198856680142', '76561199444464189',
'76561199560943084', '76561199398255134', '76561198168543191', '76561199566510345', '76561199446820521',
'76561199567317997', '76561199444225118', '76561199299076116', '76561199446577312', '76561199444614366',
'76561199566449943', '76561199446276697',
'76561199565830992', '76561199566957734', '76561199565797588', '76561199560363666', '76561199444477819',
'76561199445661444', '76561198452871326', '76561199567234868', '76561198881723374', '76561199566510345',
'76561198241310804', '76561198971088323', '76561199444732654', '76561198409714688', '76561199446325067',
'76561199233239875', '76561198363358193', '76561199398255134', '76561199299076116',
'76561199446577312', '76561199444515274', '76561198268741067', '76561199128423803', '76561199446820521',
'76561198143313052', '76561198253461712', '76561199444487575', '76561199439947393', '76561198325420763',
'76561199567292480', '76561199561580266', '76561199565355271', '76561199201428628', '76561199444798528',
'76561198168543191', '76561199562216166', '76561199246878113', '76561199445741584', '76561199446982357',
'76561199091186335', '76561199444346692', '76561198894106795', '76561199560673853', '76561198078714644',
'76561198276035177', '76561198052933985', '76561199444444175', '76561199561888244', '76561198988133057',
'76561198996939902', '76561199190154851', '76561199446321282', '76561199444459860', '76561198347246260',
'76561199446723734', '76561199567440488', '76561199128136408', '76561199446044910',
'76561199444176625', '76561198961828145', '76561199560349168', '76561199444553238', '76561199446426496',
'76561199445986207', '76561198799145737', '76561199446555835', '76561198106918547', '76561199446164858',
'76561199560673853', '76561199444419933', '76561199446664209', '76561198342495834', '76561199246604041',
'76561199407539691', '76561198894106795', '76561199444346692', '76561199033837563', '76561198385119122',
'76561199398255134', '76561198118631620', '76561199567317997', '76561199439947393', '76561199446276697',
'76561199566449943', '76561199444614366', '76561199446264814', '76561199128423803', '76561198143313052',
'76561199446820521', '76561199562216166', '76561199444225118', '76561198253461712', '76561198268741067',
'76561199444487575', '76561198856680142', '76561199444464189', '76561199567108397',
'76561199560452632', '76561199444818990', '76561198314409939', '76561199561823513', '76561199444209417',
'76561199446273177', '76561199444558890', '76561199103282699', '76561199443639726', '76561199561212527',
'76561199446366356', '76561199078775076', '76561199444515274', '76561199299076116', '76561199446099537',
'76561198249594412', '76561199375601257', '76561198088162539', '76561198430922211', '76561199214259156',
'76561198373653425', '76561199566957734', '76561199247530566', '76561199567234868', '76561199446353781',
'76561199444798528', '76561198452871326', '76561198881723374', '76561199201428628', '76561198241310804',
'76561199444477819', '76561199233239875', '76561199560851704', '76561199446947427', '76561199562216166',
'76561199439947393', '76561198143313052', '76561199444487575', '76561199128423803', '76561198268741067',
'76561199111631547', '76561198110492651', '76561198335171798', '76561198331321404', '76561199202453549',
'76561199432844355', '76561199561496107', '76561199446188434', '76561199444585896', '76561199424143954',
'76561198083956578', '76561199566957402', '76561198962009362', '76561199051487299', '76561199446577312',
'76561199444173577', '76561198281001400', '76561198799145737', '76561199446555835',
'76561199446164858', '76561198106918547', '76561199444821931', '76561199444419933', '76561199565628100',
'76561199139326977', '76561199444861724', '76561199407539691', '76561199446550193', '76561199446365079',
'76561199236334984', '76561199140155403', '76561199273917050', '76561199566819600', '76561198079770365',
'76561198366543397', '76561199445783987', '76561199560857830', '76561199086977174', '76561199444160400',
'76561198284027212', '76561199444737750', '76561199447361766', '76561199445726679', '76561198442512350',
'76561198004267110', '76561199444842269', '76561199561717289', '76561199444118557', '76561198828342646',
'76561199446444764', '76561199446986145', '76561199081904227', '76561199195157217', '76561199446180524',
'76561199445759680', '76561199445391962', '76561199112505332', '76561198352284956', '76561199397903545',
'76561198139479934', '76561199162810513', '76561199567105393', '76561198112028501', '76561199560972227',
'76561199565521520', '76561199444679009', '76561198812335003', '76561199350708811', '76561198943062270',
'76561199444133038', '76561199446001754', '76561199561267482', '76561199560700391', '76561199443326457',
'76561199444799197', '76561199567776181', '76561199445969486', '76561199445615507',
'76561199444585896', '76561199564974127', '76561198430922211', '76561199567108397', '76561199444818990',
'76561199560452632', '76561199214259156', '76561199444209417', '76561199443639726', '76561198314409939',
'76561199561212527', '76561199375601257', '76561199446099537', '76561198249594412', '76561199561823513',
'76561199212558391', '76561199444644767', '76561199444646206', '76561199560941418', '76561198880919108',
'76561199562247781', '76561199195445975', '76561199444480890', '76561199561194051', '76561198417984588',
'76561199445959890', '76561199213736494', '76561199444799197', '76561199446423848', '76561199561267482',
'76561199445615507', '76561199567776181', '76561199105087553', '76561199113465614', '76561199445718185',
'76561199560700391', '76561199328389145', '76561199444538348', '76561199567980969',
'76561199210611471', '76561199090185690', '76561198088162539', '76561199446064143', '76561198335171798',
'76561199202453549', '76561199446273177', '76561199561496107', '76561199103282699', '76561198083956578',
'76561198110492651', '76561199444558890', '76561199271231790', '76561199446099537', '76561198249594412',
'76561199561823513', '76561198168017251', '76561199212558391', '76561199444644767', '76561199561212527',
'76561199444540400', '76561198236570470', '76561198959772831', '76561199566544647', '76561198880919108',
'76561199444617582', '76561198256546311', '76561199447178507', '76561199445699769', '76561198979047348',
'76561198067380722', '76561198127685376', '76561199445440426', '76561199217797900', '76561199445931877',
'76561198992255145', '76561199444440397', '76561199565968750',
'76561198256546311', '76561199561455331', '76561199101432638', '76561198267749178', '76561199446321960',
'76561199444617582', '76561198967667643', '76561198067380722', '76561199447178507', '76561197987474055',
'76561199445931877', '76561198992255145', '76561199227762636', '76561199561317527', '76561198963617636',
'76561199565749075', '76561198096094364', '76561198327783018',
'76561198136414854', '76561199170730801', '76561199206510874', '76561199204822641', '76561199561925224',
'76561198875166964', '76561199446158157', '76561199444821945', '76561199567608867', '76561199119766614',
'76561199561611365', '76561199567125799', '76561199444538348', '76561199567980969', '76561199562247781',
'76561198417984588', '76561199445959890', '76561199213736494', '76561199561194051',
'76561199566902590', '76561198967667643', '76561198370080649', '76561198244147998', '76561198169255241',
'76561199565749075', '76561198096094364', '76561198388496925', '76561199411041869', '76561199153541963',
'76561199197817701', '76561199054154501', '76561199445922899', '76561199218766428', '76561199093919085',
'76561198216886269', '76561199564977303', '76561199445907152', '76561198136541495', '76561198277623766',
'76561199561075579', '76561199567258059', '76561197987474055', '76561199443976067', '76561199434626063',
'76561198100774521', '76561198327783018', '76561198153660744', '76561199444884071', '76561199443947745',
'76561199100869961', '76561199436701415', '76561199561674224', '76561199564517381', '76561199445006086',
'76561198371991802', '76561199446434408', '76561198409356522',
'76561199485155903', '76561199218090723', '76561199258895207', '76561199561060014', '76561199569036236',
'76561199569409694', '76561199054235999', '76561198357847338', '76561199490138362', '76561199569943351',
'76561199125803479', '76561199569891590', '76561199307477371', '76561199154904096', '76561199497238617',
'76561199522829870', '76561199372170408', '76561199569426033',
'76561199446175345', '76561199569399244', '76561199466064117', '76561198983342641', '76561199513780518',
'76561199501869988', '76561199277345843', '76561199499479496', '76561199232334889', '76561199121776194',
'76561199569505325', '76561199569426033', '76561199218090723', '76561198375555284', '76561198080128138',
'76561199569943351', '76561198357847338',
'76561199569505325', '76561199237743583', '76561198080128138', '76561198959325163', '76561199569426033',
'76561198983342641', '76561199509827197', '76561198320252518', '76561199501869988', '76561199277345843',
'76561199513780518', '76561198976362183', '76561199219534154', '76561199569168908', '76561199104008702',
'76561199569279960', '76561199385088051', '76561199474282887',
'76561199569721208', '76561199506953892', '76561199499611537', '76561199569829940', '76561199569536751',
'76561199471701176', '76561199474282887', '76561198381206130', '76561199497631078', '76561199569491768',
'76561198164903656', '76561199307477371', '76561199522829870', '76561199154904096', '76561199497238617',
'76561199125803479', '76561199145647009', '76561199219534154', '76561198083627601', '76561199569168908',
'76561199114872373', '76561198367671844', '76561199504850775', '76561199106578771', '76561199500251643',
'76561199266857168', '76561199516346367', '76561199569664766', '76561199123893479', '76561198959325163',
'76561199569505325', '76561199237743583', '76561199145647009', '76561199569399244', '76561199247944409',
'76561199466064117', '76561199446175345', '76561199121776194', '76561199232334889',
'76561199152279220', '76561199505300880', '76561199569478419', '76561199302599656', '76561199166466283',
'76561199569536751', '76561199496232481', '76561198419192859', '76561198959225375', '76561199163563453',
'76561199001144566', '76561198434754766', '76561198369359445', '76561198902553618', '76561198381365192',
'76561199171545085', '76561198855613154', '76561199206636526',
'76561199000891883', '76561198869280460', '76561199097275040', '76561199053084731', '76561198833295944',
'76561199141075422', '76561199164361968', '76561199058252349', '76561199014723966', '76561198970010879',
'76561198385118636', '76561198997344265', '76561199154659954', '76561198401555534', '76561198982249121',
'76561199206782701', '76561199212225041', '76561199154582525', '76561199109364839', '76561198992031850',
'76561198945502675', '76561198873695578', '76561199154582525', '76561198970010879', '76561199154659954',
'76561198385118636', '76561198401555534', '76561199018413042', '76561199105405723', '76561199109364839',
'76561199014723966', '76561199206782701', '76561198982249121', '76561198997344265', '76561199212225041',
'76561198987063261', '76561199164361968', '76561198884006413', '76561198859649025',
'76561198918734026', '76561198990084675', '76561199198711848', '76561199101830555', '76561198947191744',
'76561199034074281', '76561199155136246', '76561198875387554', '76561199217261945', '76561198796319783',
'76561199200660324', '76561199047828569', '76561199020784356', '76561199010825032', '76561199152386036',
'76561198809668355', '76561198895288301', '76561199097185401', '76561199155062569',
'76561199186882532', '76561199133533206', '76561199156276026', '76561199149826930', '76561199088118424',
'76561199207074416', '76561199019398476', '76561199106839689', '76561199208798322', '76561199159250682',
'76561199050993039', '76561199089394661', '76561199163481870', '76561199047362651', '76561198915677011',
'76561199069429570', '76561199080774761', '76561199095080776', '76561199020185371', '76561198900424668',
'76561198890206654', '76561199186882532', '76561199133533206', '76561199097185401', '76561199155062569',
'76561199198711848', '76561199010825032', '76561199034074281', '76561199217261945', '76561199152386036',
'76561199155136246', '76561198875387554', '76561198809668355', '76561198947191744', '76561199200660324',
'76561199047828569', '76561199163481870', '76561199077646982', '76561199096294883',
'76561199146497470', '76561199024902832', '76561199210021624', '76561199075387660', '76561198900424668',
'76561199211081302', '76561198852228049', '76561199109349387', '76561198969803341', '76561199124649300',
'76561199025519407', '76561199177277196', '76561199144543835', '76561199206269008', '76561199182219232',
'76561199124296632', '76561199126777538', '76561199176566621', '76561199109002302',
'76561199182219232', '76561199124296632', '76561199126777538', '76561199208951165', '76561199101256923',
'76561199216588708', '76561199134311680', '76561199109002302', '76561199154483291', '76561199085511373',
'76561199221370413', '76561199046645152', '76561199019664473', '76561199176566621', '76561199084613582',
'76561199019627310', '76561199120332744', '76561199630629070',
'76561199804945543', '76561199822141027', '76561199805841754', '76561199806205526', '76561199820996610',
'76561199804653637', '76561199766002846', '76561199821380348', '76561199765800575', '76561199706672171',
'76561199821970769', '76561199821556178', '76561199805529456', '76561199820849094', '76561199822328880',
'76561199821970155', '76561199821700530', '76561199749109716', '76561199749316914', '76561199749575224',
'76561199748912384', '76561199749269637', '76561199766637930', '76561199749810825', '76561199748774503',
'76561199749342318', '76561199749924797', '76561199749380684', '76561199749278460', '76561199765130384',
'76561199765668121', '76561199764957627', '76561199765939684', '76561199765709769', '76561199765338816',
'76561199766797117', '76561199765240968', '76561199765358700', '76561199765429463', '76561199764244645',
'76561199765432368', '76561199765668121', '76561199764244645', '76561199764982098', '76561199765709769',
'76561199765429463', '76561199766080841', '76561199765886841', '76561199765086398', '76561199765358700',
'76561199765524415', '76561199765338816', '76561199765253707', '76561199765240968', '76561199766797117',
'76561199765752737', '76561199765596534', '76561199765404883', '76561199820989423', '76561199821106764',
'76561199820183424', '76561199820992794', '76561199822075650', '76561199821951668', '76561199820893036',
'76561199821162540', '76561199822293423', '76561199821515252', '76561199820348657', '76561199821537967',
'76561199820811434', '76561199820989423', '76561199821954758', '76561199821660065', '76561199822191383',
'76561199820741256', '76561199803881118', '76561199821106764', '76561199819922210', '76561199821100362',
'76561199821537967', '76561199820771080', '76561199820811434', '76561199822075650', '76561199820992794',
'76561199820893036', '76561199820183424', '76561199822293423', '76561199820741256', '76561199821395851',
'76561199821106764', '76561199819922210', '76561199820541895', '76561199822268154', '76561199820607282',
'76561199821569343', '76561199821763258', '76561199821475721', '76561199820511798', '76561199820571810',
'76561199820582208', '76561199822135862', '76561199821763258', '76561199821746486', '76561199821475721',
'76561199750112645', '76561199748605737', '76561199765664946', '76561199765112828', '76561199765411652',
'76561199764632093', '76561199765113208', '76561199765143347', '76561199765155428', '76561199765796477',
'76561199765887361', '76561199749123456', '76561199749054087', '76561199749871057', '76561199749472643',
'76561199749123456', '76561199765407613', '76561199749871057', '76561199765796477', '76561199749472643',
'76561199765650015', '76561199766096811', '76561199750046747', '76561199749054087', '76561199750083123',
'76561199766609631', '76561199765410095', '76561199765367474', '76561199765872778', '76561199765503814',
'76561199766369069', '76561199765375232', '76561199765408623', '76561199765292327', '76561199765251914',s
'76561199764357951', '76561199764821790', '76561199766030182', '76561199765590722', '76561199765542600',
'76561199764795574', '76561199748711779', '76561199766229384', '76561199765712386', '76561199766108697',
'76561199765011705', '76561199765261967', '76561199765523553', '76561199749700213', '76561199765367474',
'76561199749770225', '76561199765872778', '76561199765503814', '76561199766369069', '76561199766598621',
'76561199765510317', '76561199749770225', '76561199766369069', '76561199765367474', '76561199765375232',
'76561199764357951', '76561199764821790', '76561199766030182', '76561199765514518', '76561199766229384',
'76561199765280343', '76561199765712386', '76561199765011705', '76561199765261967', '76561199749700213',
'76561199765408623', '76561199765292327', '76561199765590722', '76561199765542600', '76561199748711779',
'76561199765375232', '76561199765408623', '76561199765292327', '76561199765523553', '76561199765261967',
'76561199765011705', '76561199766439753', '76561199749700213', '76561199765712386', '76561199766229384',
'76561199766108697', '76561199750102619', '76561199765000574', '76561199750487093', '76561199765005566',
'76561199749965055', '76561199765567538', '76561199765959891', '76561199765545869', '76561199749259398',
'76561199765959891', '76561199765545869', '76561199765005566', '76561199765074128', '76561199748888169',
'76561199749833264', '76561199749200158', '76561199765725082', '76561199749781029', '76561199765210125',
'76561199765410526', '76561199764942175', '76561199749227617', '76561199764883495', '76561199765217333',
'76561199765708645', '76561199765122725', '76561199766079283', '76561199765314156', '76561199765125498',
'76561199765125498', '76561199749227617', '76561199765587951', '76561199765367378', '76561199765410526',
'76561199765217333', '76561199765763639', '76561199765413823', '76561199765314156', '76561199765708645',
'76561199765122725', '76561199765571171', '76561199766363897', '76561199765776576', '76561199766047708',
'76561199749143469', '76561199766079283', '76561199765359596', '76561199765034817', '76561199766594311',
'76561199765935725', '76561199748691782', '76561199765983955', '76561199749158607', '76561199765166067',
'76561199764876296', '76561199766594311', '76561198029967039', '76561199765704032', '76561199821267647',
'76561199765457449', '76561199764896410', '76561199765736212', '76561199749144463', '76561199765611953',
'76561199765712864', '76561199749037092', '76561199765592015', '76561199765172809',
'76561199765457449', '76561199764896410', '76561199764759316', '76561199764851392', '76561199765343150',
'76561199765592015', '76561199749037092', '76561199765611953', '76561199765249168', '76561199765172809',
'76561199749144463', '76561199766031742', '76561199765228972', '76561199766281554', '76561199766506149',
'76561199765296118', '76561199765321327', '76561199765431152', '76561199764353641', '76561199749223787',
'76561199764353641', '76561199765897288', '76561199765951095', '76561199764237749', '76561199748638924',
'76561199765319641', '76561199765431152', '76561199748637200', '76561199765588776', '76561199764719718',
'76561199764621811', '76561199765001005', '76561199748889932', '76561199766345398', '76561199766100212',
'76561199749157683', '76561199765177170', '76561199749126082', '76561199765049515', '76561198035939859',
'76561199749692921', '76561199561709587', '76561199749592795', '76561199748964660', '76561199765224660',
'76561199765339237', '76561199765911397', '76561199480394229', '76561198970348103', '76561199150264726',
'76561199570178720', '76561198389323241', '76561199185727878', '76561198344067190', '76561199569730471',
'76561198993810658', '76561199236655584', '76561198088379677', '76561198929729685',
    
]
    
    
DATA_FILE = 'friend_data.json'
INIT_FILE = '.initialized'

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger("SteamFriendIDMonitor")

def get_profile_link(steam_id):
    """Generate Steam profile link from Steam ID"""
    return f"steamcommunity.com/profiles/{steam_id}"

async def fetch_friend_list(session, steam_id):
    """Fetch the complete friend list for a Steam account"""
    url = f"http://api.steampowered.com/ISteamUser/GetFriendList/v0001/?key={STEAM_API_KEY}&steamid={steam_id}&relationship=friend"
    profile_link = get_profile_link(steam_id)
    
    try:
        async with session.get(url, timeout=10) as resp:
            if resp.status == 200:
                data = await resp.json()
                friends_data = data.get('friendslist', {}).get('friends', [])
                # Extract just the Steam IDs of friends
                friend_ids = [friend['steamid'] for friend in friends_data]
                return steam_id, profile_link, friend_ids
            elif resp.status == 403:
                logger.warning(f"{profile_link} is private")
                return steam_id, profile_link, None
            else:
                logger.error(f"{profile_link}: API error {resp.status}")
                return steam_id, profile_link, None
    except Exception as e:
        logger.error(f"Error fetching {profile_link}: {e}")
        return steam_id, profile_link, None

async def send_telegram_message(message):
    """Send message to Telegram, splitting if too long"""
    MAX_MESSAGE_LENGTH = 4000  # Leave some buffer under 4096 limit
    
    if len(message) <= MAX_MESSAGE_LENGTH:
        await _send_single_message(message)
    else:
        # Split message into chunks
        lines = message.split('\n')
        current_chunk = ""
        
        for line in lines:
            # If adding this line would exceed limit, send current chunk
            if len(current_chunk + line + '\n') > MAX_MESSAGE_LENGTH:
                if current_chunk:
                    await _send_single_message(current_chunk.strip())
                    current_chunk = line + '\n'
                else:
                    # Single line is too long, truncate it
                    await _send_single_message(line[:MAX_MESSAGE_LENGTH])
            else:
                current_chunk += line + '\n'
        
        # Send remaining chunk
        if current_chunk:
            await _send_single_message(current_chunk.strip())

async def _send_single_message(message):
    """Send a single message to Telegram"""
    url = f"https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}/sendMessage"
    payload = {
        'chat_id': TELEGRAM_CHAT_ID,
        'text': message,
        'parse_mode': 'HTML'
    }
    async with aiohttp.ClientSession() as session:
        try:
            async with session.post(url, data=payload) as resp:
                if resp.status != 200:
                    logger.error(f"Failed to send message: {await resp.text()}")
                else:
                    logger.info("Telegram message sent successfully")
        except Exception as e:
            logger.error(f"Telegram error: {e}")

def load_previous_data():
    """Load previous friend data from file"""
    try:
        with open(DATA_FILE, 'r') as f:
            return json.load(f)
    except:
        return {}

def save_data(data):
    """Save friend data to file"""
    with open(DATA_FILE, 'w') as f:
        json.dump(data, f, indent=2)

def is_first_run():
    """Check if this is the first run of the bot"""
    if os.path.exists(INIT_FILE):
        return False
    with open(INIT_FILE, 'w') as f:
        f.write(datetime.now().isoformat())
    return True

async def check_accounts():
    """Main function to check all accounts for friend changes"""
    first_run = is_first_run()
    previous_data = load_previous_data()
    current_data = {}
    all_new_friends = []
    
    async with aiohttp.ClientSession() as session:
        results = []
        BATCH_SIZE = 500  # Process 100 accounts at a time
        DELAY_BETWEEN_BATCHES = 5  # Wait 5 seconds between batches
        
        for i in range(0, len(STEAM_ACCOUNTS), BATCH_SIZE):
            batch = STEAM_ACCOUNTS[i:i + BATCH_SIZE]
            tasks = [fetch_friend_list(session, steam_id) for steam_id in batch]
            batch_results = await asyncio.gather(*tasks)
            results.extend(batch_results)
            
            # Don't delay after the last batch
            if i + BATCH_SIZE < len(STEAM_ACCOUNTS):
                logger.info(f"Processed {i + BATCH_SIZE}/{len(STEAM_ACCOUNTS)} accounts, waiting {DELAY_BETWEEN_BATCHES}s...")
                await asyncio.sleep(DELAY_BETWEEN_BATCHES)
    
    for steam_id, profile_link, friend_ids in results:
        if friend_ids is None:
            continue
            
        current_data[steam_id] = {
            'profile_link': profile_link,
            'friends': friend_ids,
            'count': len(friend_ids)
        }
        
        # Skip change detection on first run
        if first_run or steam_id not in previous_data:
            continue
            
        previous_friends = set(previous_data[steam_id].get('friends', []))
        current_friends = set(friend_ids)
        
        # Check for new friends only
        new_friends = current_friends - previous_friends
        if new_friends:
            for friend_id in new_friends:
                friend_profile_link = get_profile_link(friend_id)
                all_new_friends.append(friend_profile_link)
                logger.info(f"New friend detected: {friend_id} added to {steam_id}")
        
        # Log removed friends (no telegram notification)
        removed_friends = previous_friends - current_friends
        if removed_friends:
            for friend_id in removed_friends:
                logger.info(f"Friend removed: {friend_id} removed from {steam_id}")

    # Send batched notification for all new friends
    logger.info(f"Total new friends collected: {len(all_new_friends)}")
    logger.info(f"First run status: {first_run}")
    
    if all_new_friends and not first_run:
        if len(all_new_friends) == 1:
            msg = f"New friend: {all_new_friends[0]}"
        else:
            msg = f"New friends detected ({len(all_new_friends)}):\n\n"
            msg += "\n".join([f"â€¢ {friend_link}" for friend_link in all_new_friends])
        
        logger.info(f"Attempting to send Telegram message: {msg[:100]}...")
        await send_telegram_message(msg)
        logger.info(f"Sent batched notification for {len(all_new_friends)} new friends")
    elif all_new_friends and first_run:
        logger.info(f"New friends detected on first run (not sending notification): {len(all_new_friends)}")
    else:
        logger.info("No new friends detected in this cycle")

    # Save current data
    save_data(current_data)

    if first_run:
        # Log initial setup (no telegram messages)
        total_accounts = len(current_data)
        private_accounts = len(STEAM_ACCOUNTS) - total_accounts
        total_friends = sum(data['count'] for data in current_data.values())
        
        logger.info(f"Steam Friend ID Monitor Setup Complete")
        logger.info(f"Monitoring {total_accounts} accounts")
        logger.info(f"Total friends being tracked: {total_friends}")
        if private_accounts > 0:
            logger.info(f"{private_accounts} accounts are private")
        logger.info("Bot will now notify when specific friends are added with their Steam IDs")
    else:
        logger.info("Friend check completed")

if __name__ == '__main__':
    asyncio.run(check_accounts())
